# json-caching-proxy

NodeJs Server that caches requests and responses to memory in a HAR-like data structure. Supports JSON content as well as binary data such as images.

## Installation

Command line: ``` $ npm install -g json-caching-proxy ```

Programatically: ``` $ npm install -D json-caching-proxy ```

## Command line usage

```
json-caching-proxy [options]

  Options:

    -h, --help             output usage information
    -V, --version          output the version number
    -c, --config [path]    Load a config file of options. (Command line args will be overridden
    -u, --url [url]        Remote server to proxy (e.g. https://network:8080)
    -p, --port [number]    Port for the local proxy server
    -h, --har [path]       Load entries from a HAR file and hydrate the cache
    -b, --bust [list]      A list of cache busting query params to ignore. (e.g. --bust _:cacheSlayer:time:dc)
    -e, --exclude [regex]  Exclude specific routes from cache, (e.g. --exclude "GET /api/keep-alive/.*")
    -a, --all              Try to cache everything in addition to JSON (Overrided by --exclude argument)
    -dp, --playback        Disable cache playback
    -dr, --record          Disable recording to cache
    -cp, --prefix          Prefix for controlling proxy admin control thru HTTP
    -phi, --header         Specify a proxy header property for identifying cached responses
    -l, --log              Show log output to console

```


### Example (command line arguments)

The example below does the following things:
* Routes requests to restful-server:8080
* Runs the proxy on port 3001 on the host machine
* Caches everything (a backup of the entire website unless they are crossdomain requests)
* Ignores any requests that uses _ in the query parameter to break cache
* Excludes any keepalive requests
* Loads an existing HAR file and hydrates the cache. The HAR file may be generated by any other sources
* Logs output to the console

```
json-caching-proxy --url http://restful-server:8080  --port 3001 --all --bust _ --exclude '/keepalive' --log --har hydrate.har

```


### Example (using a config file)

The example below will load the options from a config.json file that may look like this:

```js

// Complete list of config.json options for the caching proxy
{
  "remoteServerUrl": "http://wikimapia.org",
  "proxyPort": 3001,
  "inputHarFile": "./test/test.har",
  "cacheEverything": true,
  "cacheBustingParams": ["_", "dc", "cacheSlayer"],
  "excludedRouteMatchers": ["/*.js", "/*.png"],
  "showConsoleOutput": true,
  "dataPlayback": true,
  "dataRecord": true,
  "commandPrefix": "proxy",
  "proxyHeaderIdentifier": "proxy-cache-playback"
}
```

```
json-caching-proxy --config config.js

```

### Controlling the Proxy once it's running using HTTP GET requests
```
* http://localhost:3001/proxy/playback?enabled=`[true|false]` - Start/Stop replaying persisted JSON from the cache.
* http://localhost:3001/proxy/record?enabled=`[true|false]` - Start/Stop recording JSON to file system.
* http://localhost:3001/proxy/clear - The HAR data structure that is the in-memory cache will be emptied
* http://localhost:3001/proxy/har - Download the cache into a HAR json file
```

## Programmatic Usage

```js
const JsonCachingProxy = require('json-caching-proxy');

// Complete list of options
let jsonCachingProxy = new JsonCachingProxy({
    remoteServerUrl: 'http://localhost:8080',
    proxyPort: 3001,
    harObject: null,
    commandPrefix: 'proxy',
    proxyHeaderIdentifier: 'caching-proxy-playback',
    middlewareList: [],
    excludedRouteMatchers: [new RegExp('/site/*.js'), new RegExp('/site/*.gif')],
    cacheBustingParams: ['_', 'cacheSlayer'],
    cacheEverything: false,
    dataPlayback: true,
    dataRecord: true,
    showConsoleOutput: false
});

jsonCachingProxy.start();
jsonCachingProxy.stop();

```

### Using Express Middleware

If you want the proxy to do something funky such as load browser-sync middlware, this is the property that can be used to do so. It will bypass the proxy

```js
let middlewareList = [
  { route: '/what', handle: (req, res, next) => res.send('what') },
  { route: '/hello', handle: (req, res, next) => res.send('hello') }
	];
```

## License

MIT
